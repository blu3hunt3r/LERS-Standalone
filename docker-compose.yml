version: '3.9'

# ═══════════════════════════════════════════════════════════════════
# STANDALONE LERS PLATFORM - DOCKER COMPOSE
# ═══════════════════════════════════════════════════════════════════
#
# This is a completely independent deployment of the LERS platform,
# separate from case management and investigation modules.
#
# To deploy: docker-compose -f docker-compose.lers-standalone.yml up -d
#
# ═══════════════════════════════════════════════════════════════════

services:
  # ═══════════════════════════════════════════════════════════════
  # DATABASE LAYER
  # ═══════════════════════════════════════════════════════════════

  postgres_lers:
    image: postgres:15-alpine
    container_name: lers_postgres
    environment:
      POSTGRES_DB: lers_db
      POSTGRES_USER: ${POSTGRES_USER:-lers_admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-lers_secure_pass_2025}
    ports:
      - "${POSTGRES_PORT:-5434}:5432"
    volumes:
      - lers_postgres_data:/var/lib/postgresql/data
      - ./scripts/init-lers-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - lers_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-lers_admin} -d lers_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # CACHE & MESSAGE BROKER
  # ═══════════════════════════════════════════════════════════════

  redis_lers:
    image: redis:7-alpine
    container_name: lers_redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-lers_redis_pass_2025}
    ports:
      - "${REDIS_PORT:-6380}:6379"
    volumes:
      - lers_redis_data:/data
    networks:
      - lers_network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # OBJECT STORAGE (S3-Compatible)
  # ═══════════════════════════════════════════════════════════════

  minio_lers:
    image: minio/minio:latest
    container_name: lers_minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-lers_minio_admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-lers_minio_pass_2025}
    ports:
      - "${MINIO_API_PORT:-9002}:9000"
      - "${MINIO_CONSOLE_PORT:-9003}:9001"
    volumes:
      - lers_minio_data:/data
    networks:
      - lers_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # LERS BACKEND (Django + DRF)
  # ═══════════════════════════════════════════════════════════════

  lers_backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lers_backend
    command: >
      sh -c "mkdir -p /app/logs &&
             python manage.py migrate --settings=lers_standalone.settings &&
             python manage.py collectstatic --noinput --settings=lers_standalone.settings &&
             python manage.py create_lers_default_data --settings=lers_standalone.settings &&
             gunicorn lers_standalone.wsgi:application --bind 0.0.0.0:8000 --workers 4 --timeout 600 --worker-class=sync --max-requests=1000 --max-requests-jitter=50"
    volumes:
      - ./backend:/app
      - lers_static_volume:/app/staticfiles
      - lers_media_volume:/app/media
    ports:
      - "${BACKEND_PORT:-8100}:8000"
    environment:
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-lers_admin}:${POSTGRES_PASSWORD:-lers_secure_pass_2025}@postgres_lers:5432/lers_db
      - REDIS_URL=redis://:${REDIS_PASSWORD:-lers_redis_pass_2025}@redis_lers:6379/0
      - MINIO_ENDPOINT=minio_lers:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-lers_minio_admin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-lers_minio_pass_2025}
      - MINIO_SECURE=false
      - MINIO_BUCKET_NAME=lers-evidence
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-lers_redis_pass_2025}@redis_lers:6379/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD:-lers_redis_pass_2025}@redis_lers:6379/0
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1,lers_backend}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3100,http://localhost:3101}
    depends_on:
      postgres_lers:
        condition: service_healthy
      redis_lers:
        condition: service_healthy
      minio_lers:
        condition: service_healthy
    networks:
      - lers_network
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # CELERY WORKER (Background Tasks)
  # ═══════════════════════════════════════════════════════════════

  lers_celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lers_celery_worker
    command: celery -A lers_standalone worker --loglevel=info --concurrency=4
    volumes:
      - ./backend:/app
      - lers_media_volume:/app/media
    environment:
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-lers_admin}:${POSTGRES_PASSWORD:-lers_secure_pass_2025}@postgres_lers:5432/lers_db
      - REDIS_URL=redis://:${REDIS_PASSWORD:-lers_redis_pass_2025}@redis_lers:6379/0
      - MINIO_ENDPOINT=minio_lers:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-lers_minio_admin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-lers_minio_pass_2025}
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-lers_redis_pass_2025}@redis_lers:6379/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD:-lers_redis_pass_2025}@redis_lers:6379/0
    depends_on:
      - postgres_lers
      - redis_lers
      - minio_lers
      - lers_backend
    networks:
      - lers_network
    healthcheck:
      test: ["CMD-SHELL", "celery -A lers_standalone inspect ping -d celery@$$HOSTNAME -t 10 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # CELERY BEAT (Scheduled Tasks - SLA Monitoring)
  # ═══════════════════════════════════════════════════════════════

  lers_celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lers_celery_beat
    command: celery -A lers_standalone beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    volumes:
      - ./backend:/app
    environment:
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-lers_admin}:${POSTGRES_PASSWORD:-lers_secure_pass_2025}@postgres_lers:5432/lers_db
      - REDIS_URL=redis://:${REDIS_PASSWORD:-lers_redis_pass_2025}@redis_lers:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-lers_redis_pass_2025}@redis_lers:6379/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD:-lers_redis_pass_2025}@redis_lers:6379/0
    depends_on:
      - postgres_lers
      - redis_lers
      - lers_backend
    networks:
      - lers_network
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # SOCKET.IO SERVER (Real-time Communication)
  # ═══════════════════════════════════════════════════════════════

  lers_socket_server:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lers_socket_server
    command: python socket_server_lers.py
    volumes:
      - ./backend:/app
    ports:
      - "${SOCKET_PORT:-8102}:8001"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-lers_admin}:${POSTGRES_PASSWORD:-lers_secure_pass_2025}@postgres_lers:5432/lers_db
      - REDIS_URL=redis://:${REDIS_PASSWORD:-lers_redis_pass_2025}@redis_lers:6379/0
      - DJANGO_SETTINGS_MODULE=lers_standalone.settings
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - ALLOWED_HOSTS=*
    depends_on:
      postgres_lers:
        condition: service_healthy
      redis_lers:
        condition: service_healthy
      lers_backend:
        condition: service_started
    networks:
      - lers_network
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # LAW ENFORCEMENT PORTAL (React Frontend)
  # ═══════════════════════════════════════════════════════════════

  lers_law_enforcement_portal:
    build:
      context: ./frontend_cms
      dockerfile: Dockerfile
    container_name: lers_le_portal
    volumes:
      - ./frontend_cms:/app
      - /app/node_modules
    ports:
      - "${LE_PORTAL_PORT:-3100}:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:${BACKEND_PORT:-8100}/api/v1
      - REACT_APP_SOCKET_URL=http://localhost:${SOCKET_PORT:-8102}
      - CHOKIDAR_USEPOLLING=true
      - REACT_APP_PLATFORM_NAME=LERS Law Enforcement Portal
    depends_on:
      - lers_backend
      - lers_socket_server
    networks:
      - lers_network
    stdin_open: true
    tty: true
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # PROVIDER PORTAL (React/Vite Frontend)
  # ═══════════════════════════════════════════════════════════════

  lers_provider_portal:
    build:
      context: ./frontend_provider
      dockerfile: Dockerfile
    container_name: lers_provider_portal
    volumes:
      - ./frontend_provider:/app
      - /app/node_modules
    ports:
      - "${PROVIDER_PORTAL_PORT:-3101}:3001"
    environment:
      - VITE_API_URL=http://localhost:${BACKEND_PORT:-8100}/api/v1
      - VITE_SOCKET_URL=http://localhost:${SOCKET_PORT:-8102}
      - VITE_PLATFORM_NAME=LERS Provider Portal
    depends_on:
      - lers_backend
      - lers_socket_server
    networks:
      - lers_network
    stdin_open: true
    tty: true
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  # NGINX REVERSE PROXY (Production)
  # ═══════════════════════════════════════════════════════════════

  lers_nginx:
    image: nginx:alpine
    container_name: lers_nginx
    ports:
      - "${NGINX_HTTP_PORT:-8080}:80"
      - "${NGINX_HTTPS_PORT:-8443}:443"
    volumes:
      - ./nginx/lers-nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/lers-conf.d:/etc/nginx/conf.d:ro
      - lers_static_volume:/static
      - lers_media_volume:/media
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - lers_backend
      - lers_law_enforcement_portal
      - lers_provider_portal
    networks:
      - lers_network
    restart: unless-stopped

# ═══════════════════════════════════════════════════════════════
# VOLUMES
# ═══════════════════════════════════════════════════════════════

volumes:
  lers_postgres_data:
    driver: local
  lers_redis_data:
    driver: local
  lers_minio_data:
    driver: local
  lers_static_volume:
    driver: local
  lers_media_volume:
    driver: local

# ═══════════════════════════════════════════════════════════════
# NETWORKS
# ═══════════════════════════════════════════════════════════════

networks:
  lers_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
